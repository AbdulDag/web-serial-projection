<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Map Projection Control Center</title>
    <style>
        body {
            background-color: black;
            margin: 0;
            overflow: hidden;
            color: white;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        /* STATUS DISPLAY */
        #status-text {
            position: absolute;
            top: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 30px;
            border-radius: 8px;
            border: 1px solid #333;
            font-size: 20px;
            text-align: center;
            pointer-events: none;
        }

        /* CONNECT BUTTON */
        #btn-connect {
            position: absolute;
            z-index: 2000;
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            background-color: #007bff; 
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
        }

        #btn-connect:hover {
            background-color: #0056b3;
        }

        /* PROJECTION SURFACE */
        #projection-surface {
            width: 800px;
            height: 450px;
            opacity: 0; 
            transition: opacity 1s ease-in;
        }

        #my-video {
            width: 100%;
            height: 100%;
            object-fit: fill;
        }
    </style>
</head>
<body>

    <div id="status-text">Waiting for Connection...</div>

    <button id="btn-connect" onclick="connectToArduino()">CONNECT ARDUINO</button>

    <div id="projection-surface">
        <video id="my-video" src="tunnel.mp4" loop muted playsinline></video>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/maptastic@3.0.0/dist/maptastic.min.js"></script>

    <script>
        // --- VARIABLES ---
        let port;
        let writer;
        
        let appState = 'DISCONNECTED'; 

        //TIMING 
        const LED_START_DELAY = 7000; 
        const LED_DURATION = 2000;

        // --- MAPTASTIC SETUP ---
        window.onload = function() {
            try { Maptastic("projection-surface"); } 
            catch(e) { new maptastic.Maptastic("projection-surface"); }
            
            // Setup Keyboard Listener
            document.addEventListener('keydown', handleKeyPress);
        };

        // --- KEYBOARD CONTROLS ---
        function handleKeyPress(e) {
            // 1. IGNORE if holding Shift 
            if (e.shiftKey) return;

            // 2. CHECK for Space Bar
            if (e.code === 'Space') {
                e.preventDefault(); 
                
                if (appState === 'READY') {
                    startShow();
                } else if (appState === 'FINISHED') {
                    resetShow();
                }
            }
        }

        ///connection brah
        async function connectToArduino() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                
                const textEncoder = new TextEncoderStream();
                const writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
                writer = textEncoder.writable.getWriter();

                //turn off led
                await writer.write("0");

                // Update UI
                document.getElementById('btn-connect').style.display = 'none';
                updateStatus("CONNECTED. PRESS [SPACE] TO START.");
                
                appState = 'READY';

            } catch (err) {
                console.error("Error:", err);
                alert("Failed to connect.");
            }
        }

        //display start
        async function startShow() {
            if (appState === 'RUNNING') return;
            appState = 'RUNNING';

            //forced led off
            if (writer) await writer.write("0");

            setTimeout(() => {
                // video start/fade-in
                const surface = document.getElementById('projection-surface');
                const video = document.getElementById('my-video');
                surface.style.opacity = "1";
                video.currentTime = 0;
                video.play();
                
                updateStatus("SHOW RUNNING...");

                //turn led on after 7 secs 
                setTimeout(async () => {
                    if (writer) {
                        console.log("LED ON");
                        await writer.write("1");

                        // turn led off
                        setTimeout(async () => {
                            console.log("LED OFF");
                            await writer.write("0");
                            
                            appState = 'FINISHED';
                            updateStatus("DONE. PRESS [SPACE] TO RESET.");
                        }, LED_DURATION);
                    }
                }, LED_START_DELAY);

            }, 200);
        }

        //reset
        async function resetShow() {
            if (writer) await writer.write("0");

            const surface = document.getElementById('projection-surface');
            const video = document.getElementById('my-video');
            
            surface.style.opacity = "0"; 
            
            setTimeout(() => { 
                video.pause(); 
                video.currentTime = 0; 
            }, 1000); 

            appState = 'READY';
            updateStatus("READY. PRESS [SPACE] TO START.");
        }

        function updateStatus(text) {
            document.getElementById('status-text').innerText = text;
        }
    </script>
</body>
</html>